<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•™å¸«è«‹å‡æ™‚æ•¸ç²¾ç®—ç³»çµ±</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            padding: 20px; /* é›»è…¦ç‰ˆç•™é‚Š */
        }
        
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 700px; /* é›»è…¦ç‰ˆæœ€å¤§å¯¬åº¦ */
            box-sizing: border-box;
        }

        /* --- æ‰‹æ©Ÿç‰ˆå…¨è¢å¹•å„ªåŒ– --- */
        @media (max-width: 600px) {
            body { padding: 0; } /* æ‰‹æ©Ÿå–æ¶ˆå¤–å±¤é‚Šè· */
            .card { 
                border-radius: 0; /* æ‰‹æ©Ÿå–æ¶ˆåœ“è§’ */
                min-height: 100vh; /* æ‰‹æ©Ÿå¡«æ»¿é«˜åº¦ */
                padding: 15px;
            }
            h2 { font-size: 1.2rem; }
            .setup-row { flex-direction: column; align-items: flex-start; gap: 5px; }
            input[type="number"] { width: 100% !important; box-sizing: border-box; }
            select { width: 100% !important; }
            .btn-apply, .btn-add { width: 100%; margin-top: 5px; }
        }

        h2 { color: #202124; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .setup-section { background: #fffde7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffe082; }
        .setup-title { font-weight: bold; color: #f57c00; margin-bottom: 10px; display: block; }
        .setup-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .input-section { background: #e8f0fe; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #c2d7ff; }
        .input-title { font-weight: bold; color: #1a73e8; margin-bottom: 10px; display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f1f3f4; color: #5f6368; }
        .personal-group-row { background-color: #fff8f0 !important; }
        .personal-summary-row { background-color: #ffe0b2 !important; font-weight: bold; color: #e65100; border: 2px solid #fb8c00; }
        .final-analysis-card { background-color: #e8f5e9; border: 2px solid #4caf50; padding: 20px; border-radius: 10px; margin-top: 25px; }
        .analysis-title { color: #2e7d32; font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; display: block; text-align: center; }
        .highlight-num { font-size: 1.3rem; color: #d32f2f; font-weight: bold; text-decoration: underline; }
        .btn-reset { width: 100%; padding: 5px; background: none; color: #ccc; border: 1px solid #eee; border-radius: 5px; cursor: pointer; margin-top: 30px; font-size: 11px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ æ•™å¸«è«‹å‡ç²¾ç®—ç³»çµ± (æ‰‹æ©Ÿç‰ˆ)</h2>

    <div class="setup-section">
        <span class="setup-title">âš™ï¸ åŸºç¤é¡åº¦è¨­å®š</span>
        <div class="setup-row">
            <label>å€‹äººç‰¹ä¼‘å¤©æ•¸ï¼š</label>
            <select id="annualLeaveInput" onchange="updateLimits()">
                <option value="0">0å¤©</option><option value="7">7å¤©</option><option value="14">14å¤©</option>
                <option value="21">21å¤©</option><option value="28">28å¤©</option><option value="30">30å¤©</option>
            </select>
        </div>
        <div class="setup-row">
            <label>å­˜å…¥è£œä¼‘ï¼š</label>
            <select id="compType">
                <option value="åŠ ç­è£œä¼‘">åŠ ç­è£œä¼‘</option><option value="å…¬å‡è£œä¼‘">å…¬å‡è£œä¼‘</option>
            </select>
            <div>
                <input type="number" id="addDays" style="width: 45px;" placeholder="æ—¥"> æ—¥
                <input type="number" id="addHours" style="width: 45px;" placeholder="æ™‚"> æ™‚
            </div>
            <button class="btn-add" onclick="addCompLimit()">å­˜å…¥</button>
        </div>
    </div>
    
    <div class="input-section">
        <span class="input-title">ğŸ“ ç™»è¨˜è«‹å‡</span>
        <div class="setup-row">
            <label>é¸æ“‡å‡åˆ¥ï¼š</label>
            <select id="leaveType" style="flex-grow: 1;">
                <option value="èº«å¿ƒèª¿é©å‡">èº«å¿ƒèª¿é©å‡ (å„ªå…ˆ3å¤©)</option>
                <option value="äº‹å‡">äº‹å‡</option>
                <option value="å®¶åº­ç…§é¡§å‡">å®¶åº­ç…§é¡§å‡</option>
                <option value="ç—…å‡">ç—…å‡</option>
                <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
                <option value="åŠ ç­è£œä¼‘">åŠ ç­è£œä¼‘</option>
                <option value="å…¬å‡è£œä¼‘">å…¬å‡è£œä¼‘</option>
            </select>
        </div>
        <div class="setup-row">
            <label>è«‹å‡æ™‚é•·ï¼š</label>
            <div>
                <input type="number" id="leaveDays" style="width: 50px;" placeholder="0"> æ—¥
                <input type="number" id="leaveHours" style="width: 50px;" placeholder="0"> æ™‚
            </div>
            <button class="btn-apply" onclick="applyLeave()">é€å‡º</button>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <div id="statusTable"></div>
    </div>
    
    <div class="final-analysis-card" id="analysisPanel"></div>

    <button class="btn-reset" onclick="resetData()">é‡ç½®æ‰€æœ‰æ•¸æ“š</button>
</div>

<script>
    let state = JSON.parse(localStorage.getItem('teacher_leave_mobile')) || {
        limits: { "äº‹å‡": 56, "èº«å¿ƒèª¿é©å‡": 24, "å®¶åº­ç…§é¡§å‡": 56, "ç—…å‡": 224, "ç‰¹ä¼‘": 0, "åŠ ç­è£œä¼‘": 0, "å…¬å‡è£œä¼‘": 0 },
        used: { "äº‹å‡": 0, "èº«å¿ƒèª¿é©å‡": 0, "å®¶åº­ç…§é¡§å‡": 0, "ç—…å‡": 0, "ç‰¹ä¼‘": 0, "åŠ ç­è£œä¼‘": 0, "å…¬å‡è£œä¼‘": 0 },
        settings: { annualDays: "0" }
    };

    function formatTime(totalH) {
        if (totalH < 0) return "0æ—¥ 0æ™‚";
        return Math.floor(totalH / 8) + "æ—¥ " + (totalH % 8) + "æ™‚";
    }

    function addCompLimit() {
        let type = document.getElementById('compType').value;
        let d = parseInt(document.getElementById('addDays').value) || 0;
        let h = parseInt(document.getElementById('addHours').value) || 0;
        state.limits[type] += (d * 8 + h);
        document.getElementById('addDays').value = ""; document.getElementById('addHours').value = "";
        updateView();
    }

    function updateLimits() {
        let days = document.getElementById('annualLeaveInput').value;
        state.settings.annualDays = days;
        state.limits["ç‰¹ä¼‘"] = parseInt(days) * 8;
        updateView();
    }

    function updateView() {
        localStorage.setItem('teacher_leave_mobile', JSON.stringify(state));
        document.getElementById('annualLeaveInput').value = state.settings.annualDays;
        
        let html = `<table><tr><th>å‡åˆ¥</th><th>å·²ä½¿ç”¨</th><th>å‰©é¤˜</th></tr>`;
        const keys = ["èº«å¿ƒèª¿é©å‡", "äº‹å‡", "å®¶åº­ç…§é¡§å‡", "ç—…å‡", "ç‰¹ä¼‘", "åŠ ç­è£œä¼‘", "å…¬å‡è£œä¼‘"];
        
        keys.forEach(key => {
            let isPersonal = ["äº‹å‡", "èº«å¿ƒèª¿é©å‡", "å®¶åº­ç…§é¡§å‡"].includes(key);
            let rowClass = isPersonal ? 'class="personal-group-row"' : '';
            html += `<tr ${rowClass}><td>${key}</td><td>${formatTime(state.used[key])}</td><td>${formatTime(state.limits[key] - state.used[key])}</td></tr>`;
            
            if (key === "å®¶åº­ç…§é¡§å‡") {
                let pUsed = state.used["äº‹å‡"] + state.used["èº«å¿ƒèª¿é©å‡"] + state.used["å®¶åº­ç…§é¡§å‡"];
                html += `<tr class="personal-summary-row"><td>ğŸ”¸äº‹å‡é«”ç³»(åˆè¨ˆ)</td><td>${formatTime(pUsed)}</td><td>é¤˜:${formatTime(56 - pUsed)}</td></tr>`;
            }
        });
        html += `</table>`;
        document.getElementById('statusTable').innerHTML = html;

        calculateFinalSafety();
    }

    function calculateFinalSafety() {
        // å®‰å…¨ç·š: 14å¤©(112å°æ™‚)
        let personalUsed = state.used["äº‹å‡"] + state.used["èº«å¿ƒèª¿é©å‡"] + state.used["å®¶åº­ç…§é¡§å‡"];
        let sickUsed = state.used["ç—…å‡"];
        let safetyRemain = Math.max(0, 112 - (personalUsed + sickUsed));

        // ç‰¹ä¼‘: åƒ…è¨ˆ10å¤©(80å°æ™‚)
        let specialUsed = state.used["ç‰¹ä¼‘"];
        let specialUsefulRemain = Math.max(0, 80 - specialUsed);

        // è£œä¼‘
        let compRem = (state.limits["åŠ ç­è£œä¼‘"] - state.used["åŠ ç­è£œä¼‘"]) + (state.limits["å…¬å‡è£œä¼‘"] - state.used["å…¬å‡è£œä¼‘"]);
        
        let grandTotalH = safetyRemain + specialUsefulRemain + compRem;

        document.getElementById('analysisPanel').innerHTML = `
            <span class="analysis-title">ğŸ“Š å­¸æœŸå‰©é¤˜å‡ç¸½é¡ (ä¸æ‰£è€ƒç¸¾)</span>
            <div style="line-height: 1.8; font-size: 14px;">
                1. äº‹ç—…å‡è€ƒç¸¾å®‰å…¨é¤˜é¡ï¼š${formatTime(safetyRemain)}<br>
                2. ç‰¹ä¼‘å¯ç”¨é¤˜é¡ (ä¸Šé™10æ—¥)ï¼š${formatTime(specialUsefulRemain)}<br>
                3. è£œä¼‘åˆè¨ˆé¤˜é¡ï¼š${formatTime(compRem)}<br>
                <div style="margin-top:10px; border-top: 1px solid #4caf50; padding-top: 10px;">
                    <strong>ğŸ’¡ æ‚¨é€™å­¸æœŸé‚„èƒ½ä¼‘ï¼š<span class="highlight-num">${formatTime(grandTotalH)}</span></strong>
                </div>
            </div>
        `;
    }

    function applyLeave() {
        let type = document.getElementById('leaveType').value;
        let d = parseInt(document.getElementById('leaveDays').value) || 0;
        let h = parseInt(document.getElementById('leaveHours').value) || 0;
        let total = (d * 8) + h;
        if (total <= 0) return alert("è«‹è¼¸å…¥æ™‚æ•¸");

        let tempUsed = {...state.used};
        tempUsed[type] += total;

        let pSum = tempUsed["äº‹å‡"] + tempUsed["èº«å¿ƒèª¿é©å‡"] + tempUsed["å®¶åº­ç…§é¡§å‡"];
        let tSum = pSum + tempUsed["ç—…å‡"];

        if (tempUsed[type] > state.limits[type]) return alert(`è¶…é ${type} å–®é …ä¸Šé™ï¼`);
        if (pSum > 56) return alert("äº‹å‡é«”ç³»åˆè¨ˆä¸å¯è¶…é 7 æ—¥ï¼");
        if (tSum > 112) {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šå·²è¶…é 14 æ—¥è€ƒç¸¾ç´…ç·šï¼æ˜¯å¦è¨˜éŒ„ï¼Ÿ")) return;
        }

        state.used = tempUsed;
        updateView();
        document.getElementById('leaveDays').value = ""; document.getElementById('leaveHours').value = "";
    }

    function resetData() { if(confirm("ç¢ºå®šé‡ç½®å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    updateView();
</script>

</body>
</html>
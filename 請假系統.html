<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="UTF-8">
    <title>æ•™å¸«è«‹å‡æ§ç®¡ - è€ƒç¸¾ç²¾ç®—ç‰ˆ</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h2 { color: #202124; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* è¨­å®šå€åŸŸ */
        .setup-section { background: #fffde7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffe082; }
        .setup-title { font-weight: bold; color: #f57c00; margin-bottom: 10px; display: block; }
        .setup-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        
        /* è¼¸å…¥å€åŸŸ */
        .input-section { background: #e8f0fe; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #c2d7ff; }
        .input-title { font-weight: bold; color: #1a73e8; margin-bottom: 10px; display: block; }
        
        /* æŒ‰éˆ•èˆ‡è¼¸å…¥ */
        select, input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        .btn-apply { padding: 10px 25px; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-add { padding: 8px 15px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f1f3f4; color: #5f6368; }
        
        /* é¡è‰²å€åˆ† */
        .personal-group-row { background-color: #fff8f0 !important; }
        .personal-summary-row { background-color: #ffe0b2 !important; font-weight: bold; color: #e65100; border: 2px solid #fb8c00; }
        .final-analysis-card { background-color: #e8f5e9; border: 2px solid #4caf50; padding: 20px; border-radius: 10px; margin-top: 25px; }
        .analysis-title { color: #2e7d32; font-size: 18px; font-weight: bold; margin-bottom: 15px; display: block; text-align: center; }
        
        .highlight-num { font-size: 20px; color: #d32f2f; font-weight: bold; text-decoration: underline; }
        .btn-reset { width: 100%; padding: 5px; background: none; color: #ccc; border: 1px solid #eee; border-radius: 5px; cursor: pointer; margin-top: 30px; font-size: 11px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ æ•™å¸«è«‹å‡æ™‚æ•¸ç²¾ç®—ç³»çµ±</h2>

    <div class="setup-section">
        <span class="setup-title">âš™ï¸ åŸºç¤é¡åº¦è¨­å®š</span>
        <div class="setup-row">
            <label>å€‹äººç‰¹ä¼‘å¤©æ•¸ï¼š</label>
            <select id="annualLeaveInput" onchange="updateLimits()">
                <option value="0">0å¤©</option><option value="7">7å¤©</option><option value="14">14å¤©</option>
                <option value="21">21å¤©</option><option value="28">28å¤©</option><option value="30">30å¤©</option>
            </select>
            <small>(ç¸½é‡ä¾ç³»çµ±é¡¯ç¤ºï¼Œç¸½çµç®—åƒ…å–10å¤©)</small>
        </div>
        <div class="setup-row">
            <label>å­˜å…¥è£œä¼‘ï¼š</label>
            <select id="compType">
                <option value="åŠ ç­è£œä¼‘">åŠ ç­è£œä¼‘</option><option value="å…¬å‡è£œä¼‘">å…¬å‡è£œä¼‘</option>
            </select>
            <input type="number" id="addDays" style="width: 45px;" placeholder="æ—¥"> <small>æ—¥</small>
            <input type="number" id="addHours" style="width: 45px;" placeholder="æ™‚"> <small>æ™‚</small>
            <button class="btn-add" onclick="addCompLimit()">å­˜å…¥</button>
        </div>
    </div>
    
    <div class="input-section">
        <span class="input-title">ğŸ“ ç™»è¨˜è«‹å‡</span>
        <div class="setup-row">
            <label>å‡åˆ¥ï¼š</label>
            <select id="leaveType" style="flex-grow: 1;">
                <option value="èº«å¿ƒèª¿é©å‡">èº«å¿ƒèª¿é©å‡ (å„ªå…ˆ)</option>
                <option value="äº‹å‡">äº‹å‡</option>
                <option value="å®¶åº­ç…§é¡§å‡">å®¶åº­ç…§é¡§å‡</option>
                <option value="ç—…å‡">ç—…å‡</option>
                <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
                <option value="åŠ ç­è£œä¼‘">åŠ ç­è£œä¼‘</option>
                <option value="å…¬å‡è£œä¼‘">å…¬å‡è£œä¼‘</option>
            </select>
        </div>
        <div class="setup-row">
            <label>æ™‚é•·ï¼š</label>
            <input type="number" id="leaveDays" style="width: 50px;" placeholder="0"> <small>æ—¥</small>
            <input type="number" id="leaveHours" style="width: 50px;" placeholder="0"> <small>æ™‚</small>
            <button class="btn-apply" style="margin-left: auto;" onclick="applyLeave()">é€å‡ºç”³è«‹</button>
        </div>
    </div>

    <div id="statusTable"></div>
    
    <div class="final-analysis-card" id="analysisPanel">
        </div>

    <button class="btn-reset" onclick="resetData()">é‡ç½®ç³»çµ±</button>
</div>

<script>
    let state = JSON.parse(localStorage.getItem('teacher_leave_final')) || {
        limits: { "äº‹å‡": 56, "èº«å¿ƒèª¿é©å‡": 24, "å®¶åº­ç…§é¡§å‡": 56, "ç—…å‡": 224, "ç‰¹ä¼‘": 0, "åŠ ç­è£œä¼‘": 0, "å…¬å‡è£œä¼‘": 0 },
        used: { "äº‹å‡": 0, "èº«å¿ƒèª¿é©å‡": 0, "å®¶åº­ç…§é¡§å‡": 0, "ç—…å‡": 0, "ç‰¹ä¼‘": 0, "åŠ ç­è£œä¼‘": 0, "å…¬å‡è£œä¼‘": 0 },
        settings: { annualDays: "0" }
    };

    function formatTime(totalH) {
        if (totalH < 0) return "0æ—¥ 0æ™‚";
        return Math.floor(totalH / 8) + "æ—¥ " + (totalH % 8) + "æ™‚";
    }

    function addCompLimit() {
        let type = document.getElementById('compType').value;
        let d = parseInt(document.getElementById('addDays').value) || 0;
        let h = parseInt(document.getElementById('addHours').value) || 0;
        state.limits[type] += (d * 8 + h);
        document.getElementById('addDays').value = ""; document.getElementById('addHours').value = "";
        updateView();
    }

    function updateLimits() {
        let days = document.getElementById('annualLeaveInput').value;
        state.settings.annualDays = days;
        state.limits["ç‰¹ä¼‘"] = parseInt(days) * 8;
        updateView();
    }

    function updateView() {
        localStorage.setItem('teacher_leave_final', JSON.stringify(state));
        document.getElementById('annualLeaveInput').value = state.settings.annualDays;
        
        // 1. æ¸²æŸ“ä¸»è¡¨
        let html = `<table><tr><th>å‡åˆ¥é¡å‹</th><th>å·²ä½¿ç”¨</th><th>å–®é …å‰©é¤˜</th></tr>`;
        const keys = ["èº«å¿ƒèª¿é©å‡", "äº‹å‡", "å®¶åº­ç…§é¡§å‡", "ç—…å‡", "ç‰¹ä¼‘", "åŠ ç­è£œä¼‘", "å…¬å‡è£œä¼‘"];
        
        keys.forEach(key => {
            let isPersonal = ["äº‹å‡", "èº«å¿ƒèª¿é©å‡", "å®¶åº­ç…§é¡§å‡"].includes(key);
            let rowClass = isPersonal ? 'class="personal-group-row"' : '';
            html += `<tr ${rowClass}><td>${key}</td><td>${formatTime(state.used[key])}</td><td>${formatTime(state.limits[key] - state.used[key])}</td></tr>`;
            
            if (key === "å®¶åº­ç…§é¡§å‡") {
                let pUsed = state.used["äº‹å‡"] + state.used["èº«å¿ƒèª¿é©å‡"] + state.used["å®¶åº­ç…§é¡§å‡"];
                html += `<tr class="personal-summary-row"><td>ğŸ”¸äº‹å‡é«”ç³»(åˆè¨ˆ)</td><td>${formatTime(pUsed)}</td><td>å‰©é¤˜: ${formatTime(56 - pUsed)}</td></tr>`;
            }
        });
        html += `</table>`;
        document.getElementById('statusTable').innerHTML = html;

        // 2. æ ¸å¿ƒç²¾ç®—é‚è¼¯
        calculateFinalSafety();
    }

    function calculateFinalSafety() {
        // A. äº‹ç—…å‡å®‰å…¨é¡åº¦ (14å¤© = 112å°æ™‚)
        let personalUsed = state.used["äº‹å‡"] + state.used["èº«å¿ƒèª¿é©å‡"] + state.used["å®¶åº­ç…§é¡§å‡"];
        let sickUsed = state.used["ç—…å‡"];
        let totalPersonalSickUsed = personalUsed + sickUsed;
        let safetyRemain = 112 - totalPersonalSickUsed; // è€ƒç¸¾ç·šå‰©é¤˜æ™‚æ•¸

        // B. ç‰¹ä¼‘å¯ç”¨é¡åº¦ (é™åˆ¶10å¤© = 80å°æ™‚)
        let specialUsed = state.used["ç‰¹ä¼‘"];
        let specialUsefulRemain = Math.max(0, 80 - specialUsed); // 10å¤©æ‰£æ‰å·²ä¼‘

        // C. è£œä¼‘é¡åº¦
        let overRem = state.limits["åŠ ç­è£œä¼‘"] - state.used["åŠ ç­è£œä¼‘"];
        let offiRem = state.limits["å…¬å‡è£œä¼‘"] - state.used["å…¬å‡è£œä¼‘"];
        
        // D. ç¸½åŠ ç¸½
        let grandTotalH = safetyRemain + specialUsefulRemain + overRem + offiRem;

        document.getElementById('analysisPanel').innerHTML = `
            <span class="analysis-title">ğŸ“Š æœ¬å­¸æœŸå‰©é¤˜å¯ä¼‘å‡ç¸½æ•¸ (å®‰å…¨ç²¾ç®—)</span>
            <table style="background:none; border:none;">
                <tr><td style="text-align:left; border:none;">1. äº‹ç—…å‡è€ƒç¸¾ç·šå‰©é¤˜ (äº‹+ç—… â‰¤ 14æ—¥)</td><td style="border:none;">${formatTime(safetyRemain)}</td></tr>
                <tr><td style="text-align:left; border:none;">2. ç‰¹ä¼‘å¯ç”¨é¤˜é¡ (åƒ…å–ä¸Šé™ 10æ—¥)</td><td style="border:none;">${formatTime(specialUsefulRemain)}</td></tr>
                <tr><td style="text-align:left; border:none;">3. åŠ ç­/å…¬å‡è£œä¼‘å‰©é¤˜</td><td style="border:none;">${formatTime(overRem + offiRem)}</td></tr>
                <tr style="border-top: 2px solid #4caf50;">
                    <td style="text-align:left; border:none; font-weight:bold; font-size:16px;">ğŸ’¡ ç¸½è¨ˆé‚„èƒ½è«‹ (ä¸å½±éŸ¿è€ƒç¸¾)ï¼š</td>
                    <td style="border:none;"><span class="highlight-num">${formatTime(grandTotalH)}</span></td>
                </tr>
            </table>
            <p style="font-size:12px; color:#666; margin-top:10px;">
                * è¨»1ï¼šå·²é ç•™ä¸¦å„ªå…ˆæ‰£é™¤ 3 æ—¥èº«å¿ƒèª¿é©å‡ç©ºé–“ã€‚<br>
                * è¨»2ï¼šè€ƒç¸¾ç·šè¨ˆç®—åŒ…å«ï¼šäº‹å‡ã€èº«å¿ƒã€å®¶åº­å‡ã€ç—…å‡ã€‚
            </p>
        `;
    }

    function applyLeave() {
        let type = document.getElementById('leaveType').value;
        let d = parseInt(document.getElementById('leaveDays').value) || 0;
        let h = parseInt(document.getElementById('leaveHours').value) || 0;
        let total = (d * 8) + h;
        if (total <= 0) return alert("è«‹è¼¸å…¥æ™‚æ•¸");

        let tempUsed = {...state.used};
        tempUsed[type] += total;

        let pSum = tempUsed["äº‹å‡"] + tempUsed["èº«å¿ƒèª¿é©å‡"] + tempUsed["å®¶åº­ç…§é¡§å‡"];
        let tSum = pSum + tempUsed["ç—…å‡"];

        if (tempUsed[type] > state.limits[type]) return alert(`è¶…é ${type} å–®é …ä¸Šé™ï¼`);
        if (pSum > 56) return alert("äº‹å‡é«”ç³»(å«èº«å¿ƒã€å®¶åº­)åˆè¨ˆä¸å¯è¶…é 7 æ—¥ï¼");
        if (tSum > 112) {
            if(!confirm("âš ï¸ å·²è¶…é 14 æ—¥è€ƒç¸¾ç´…ç·šï¼ç¢ºå®šè¦è¨˜éŒ„å—ï¼Ÿ")) return;
        }

        state.used = tempUsed;
        updateView();
        document.getElementById('leaveDays').value = ""; document.getElementById('leaveHours').value = "";
    }

    function resetData() { if(confirm("ç¢ºå®šé‡ç½®å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    updateView();
</script>

</body>
</html>